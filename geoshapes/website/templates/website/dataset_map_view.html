{% extends "website/base.html" %}
{% load url from future %}
{% load utilfilters %}


{% block extra_head %}
    <style>
		 
		#map {
			width: 100%;
			height: 500px;
			border: 1px solid black;
			background: #ccc;
		}	
		
		#map img { max-width:none; }
	</style>

{% endblock %}


{% block content %}

<div class="container">

    <div class="row">
        <div class="span12">
        <h2>Dataset</h2>
        <a href="{% url "website.views.descriptor" descriptor.id %}">To descriptor</a>
        <div id="map">
        
        
        </div>
        
        
        <script>
        </script>
                
        </div>
        
    </div>
</div>


{% endblock %}

{% block extra_body %}
    <!--<script src='http://openlayers.org/api/OpenLayers.js'></script>-->
    <script src='{{STATIC_URL}}/website/js/vendor/OpenLayers/OpenLayers.js'></script>
    
    <script>
    
        $(function(){
        
            //ajaxutils.openModal('loadingBaseOpenLayers', {'body': 'Loading Openlayers'});
            //ajaxutils.alertMessage("Loading base layers");
            var data_url = '{% url "website.views.dataset_geodata_ajax_chunks" descriptor.id %}';
            var map = new OpenLayers.Map('map');
            var osm = new OpenLayers.Layer.OSM({});
            map.addLayer(osm);
            map.zoomToMaxExtent();    
            //ajaxutils.alertMessage("Base layers loaded", 'alert-success');            
            //ajaxutils.closeModal('loadingBaseOpenLayers');
            
            
        var createLayer = function(){
            var geojson_layer = new OpenLayers.Layer.Vector("GeoJSON", {
            });    
            return layer;
            
        };
        
        
        var addFeaturesToLayer = function(layer, features){

            var geojson_format = new OpenLayers.Format.GeoJSON({
                'internalProjection': map.baseLayer.projection,
                'externalProjection': new OpenLayers.Projection("EPSG:4326")
            });

            for(var i=0,n=features.length;i<n;i++){
                var feat = features[i];
                var fr = geojson_format.read(JSON.stringify(feat));
                layer.addFeatures(fr);
            }

        
        };
        
        var addLayer = function(features){
            var geojson_layer = new OpenLayers.Layer.Vector("GeoJSON", {
            });  
    
            var geojson_format = new OpenLayers.Format.GeoJSON({
                'internalProjection': map.baseLayer.projection,
                'externalProjection': new OpenLayers.Projection("EPSG:4326")
            });
            
            
            for(var i=0,n=features.length;i<n;i++){
                var feat = features[i];
                var fr = geojson_format.read(JSON.stringify(feat));
                geojson_layer.addFeatures(fr);
            }

            map.addLayer(geojson_layer);
            map.zoomToExtent(geojson_layer.getDataExtent());
            console.log(geojson_layer);
        
        };
        /*
        var.setupPopups = function(){
    
            var field=self.inputObservables['popup_field']();  
            if(!field){
                console.log("no field set");
                return;
            }
          
        
            if(self.geojson_layer){
                
                controls = self.map.getControlsByClass("OpenLayers.Control.SelectFeature");
                for(var i=0,n=controls.length;i<n;i++){
                    controls[i].destroy();
                }
                
                var selectControl = new OpenLayers.Control.SelectFeature(self.geojson_layer,
                {
                    //onSelect: onPopupFeatureSelect,
                    //onUnselect: onPopupFeatureUnselect 
                });
              
                var onPopupFeatureSelect = function(feature) {
                    var selectedFeature = feature;
                    var txt = sketchui.getField(selectedFeature, "attributes."+field);
                    
                    popup = new OpenLayers.Popup.FramedCloud("chicken",
                        feature.geometry.getBounds().getCenterLonLat(),
                        null, txt, null, true);
                    
                    popup.panMapIfOutOfView = true;
                    popup.autoSize = true;
                    feature.popup = popup;
                    self.map.addPopup(popup);
                }
                var onPopupFeatureUnselect = function(feature) {
                    self.map.removePopup(feature.popup);
                    feature.popup.destroy();
                    feature.popup = null;
                }
                
                selectControl.onSelect = onPopupFeatureSelect;
                selectControl.onUnselect = onPopupFeatureUnselect;
                
                
                self.map.addControl(selectControl);
                selectControl.activate();
                
                
            }
        
        };
        */
        
        
        var loadLayer = function(){    
            
            $.ajax({
                url : data_url,
                type : 'GET',
                async : false,
                dataType : 'json',
                success : function(response){
                    console.log(response);
                    addLayer(JSON.parse(response.result.rows).feaures);
                
                }
            });
        };
        
        
        var loadChunks = function(url, callback, callbackstop){
            
            console.log("ch", url);
            $.ajax({
                url : url,
                type : 'GET',
                async : false,
                dataType : 'json',
                success : function(response){
                    callback(response);
                    if(response.result.next_url){
                        console.log("ss",response.result.next_url);
                        loadChunks(response.result.next_url, callback, callbackstop);
                     } else {
                        callbackstop(response);
                     }
                    
                }
            });
        
        
        
        }
        
        
        var loadLayerChunks = function(){    
            var geojson_layer = new OpenLayers.Layer.Vector("GeoJSON", {
            });   
            map.addLayer(geojson_layer);
            
            
            var rows = [];
            loadChunks(data_url,
                function(response){
                    //rows = rows.concat(JSON.parse(response.result.rows).features);
                    addFeaturesToLayer(geojson_layer, JSON.parse(response.result.rows).features);
                    geojson_layer.redraw();
                },
                function(response){
                    map.zoomToExtent(geojson_layer.getDataExtent());
                }
            );
            
            
        };
        
        
        
        ajaxutils.openModal('loading', {'body': '<p>Loading Dataset</p><img src="{{ STATIC_URL}}website/img/ajax-loader.gif"/>'});
        loadLayerChunks();
        ajaxutils.closeModal('loading');
        //ajaxutils.alertMessage("Dataset loaded", 'alert-success');   
        
        });
    
    
    </script>

{% endblock %}